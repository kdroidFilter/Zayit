name: CI - Build Check

on:
  pull_request:
    branches:
      - master
      - main

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install JBR 25
        run: |
          curl -L -o jbr.tar.gz "https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk-25.0.1-linux-x64-b268.52.tar.gz"
          mkdir -p "$RUNNER_TEMP/jbr"
          tar -xzf jbr.tar.gz -C "$RUNNER_TEMP/jbr"
          JBR_DIR=$(find "$RUNNER_TEMP/jbr" -mindepth 1 -maxdepth 1 -type d -name "jbr*" -o -name "jbrsdk*" | head -n 1)
          echo "JAVA_HOME=$JBR_DIR" >> "$GITHUB_ENV"
          echo "$JBR_DIR/bin" >> "$GITHUB_PATH"

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run ktlint
        run: ./gradlew ktlintCheck --no-daemon

  website:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: Install dependencies
        working-directory: website
        run: npm ci

      - name: Build website
        working-directory: website
        run: npm run build

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install JBR 25
        run: |
          curl -L -o jbr.tar.gz "https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk-25.0.1-linux-x64-b268.52.tar.gz"
          mkdir -p "$RUNNER_TEMP/jbr"
          tar -xzf jbr.tar.gz -C "$RUNNER_TEMP/jbr"
          JBR_DIR=$(find "$RUNNER_TEMP/jbr" -mindepth 1 -maxdepth 1 -type d -name "jbr*" -o -name "jbrsdk*" | head -n 1)
          echo "JAVA_HOME=$JBR_DIR" >> "$GITHUB_ENV"
          echo "$JBR_DIR/bin" >> "$GITHUB_PATH"

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests with coverage
        run: ./gradlew :SeforimApp:jvmTest :SeforimApp:koverXmlReport :SeforimApp:koverHtmlReport --no-daemon

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: '**/build/reports/tests/'
          retention-days: 7

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            **/build/reports/kover/
          retention-days: 7

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64 (DEB)
          - os: ubuntu-latest
            jdk_url: "https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk-25.0.1-linux-x64-b268.52.tar.gz"
            arch: amd64
            build_task: ":SeforimApp:packageReleaseDeb"

          # Windows x64
          - os: windows-latest
            jdk_url: "https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk-25.0.1-windows-x64-b268.52.zip"
            arch: amd64
            build_task: ":SeforimApp:packageReleaseMsi"

          # macOS Apple Silicon (ARM64)
          - os: macos-latest
            jdk_url: "https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk-25.0.1-osx-aarch64-b268.52.tar.gz"
            arch: arm64
            build_task: ":SeforimApp:packageReleaseDmg"

    steps:
      - name: Checkout source (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # Linux JDK Install
      - name: Install JBR on Linux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          curl -L -o jbr.tar.gz "${{ matrix.jdk_url }}"
          mkdir -p "$RUNNER_TEMP/jbr"
          tar -xzf jbr.tar.gz -C "$RUNNER_TEMP/jbr"
          JBR_DIR=$(find "$RUNNER_TEMP/jbr" -mindepth 1 -maxdepth 1 -type d -name "jbr*" -o -name "jbrsdk*" | head -n 1)
          echo "JAVA_HOME=$JBR_DIR" >> "$GITHUB_ENV"
          echo "$JBR_DIR/bin" >> "$GITHUB_PATH"

      # Windows JDK Install
      - name: Install JBR on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "${{ matrix.jdk_url }}" -OutFile "$env:RUNNER_TEMP\jbr.zip"
          Expand-Archive -Path "$env:RUNNER_TEMP\jbr.zip" -DestinationPath "$env:RUNNER_TEMP\jbr" -Force
          $jbrDir = Get-ChildItem "$env:RUNNER_TEMP\jbr" | Where-Object { $_.PSIsContainer } | Select-Object -First 1
          "$([string]::Format('JAVA_HOME={0}', $jbrDir.FullName))" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "$($jbrDir.FullName)\bin" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8

      # macOS JDK Install
      - name: Install JBR on macOS
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          curl -L -o jbr.tar.gz "${{ matrix.jdk_url }}"
          mkdir -p "$RUNNER_TEMP/jbr"
          tar -xzf jbr.tar.gz -C "$RUNNER_TEMP/jbr"
          ROOT_DIR=$(find "$RUNNER_TEMP/jbr" -mindepth 1 -maxdepth 1 -type d | head -n 1)
          JAVA_HOME="$ROOT_DIR/Contents/Home"
          echo "JAVA_HOME=$JAVA_HOME" >> "$GITHUB_ENV"
          echo "$JAVA_HOME/bin" >> "$GITHUB_PATH"

      # Gradle Setup
      - name: Set up Gradle
        uses: gradle/gradle-build-action@v3

      # Build
      - name: Build on Linux
        if: runner.os == 'Linux'
        run: |
          chmod +x ./gradlew
          ./gradlew :SeforimApp:createReleaseDistributable ${{ matrix.build_task }} --no-daemon

      - name: Build on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: .\gradlew.bat :SeforimApp:createReleaseDistributable ${{ matrix.build_task }} --no-daemon

      # Build Rust installer for Windows
      - name: Install Rust toolchain
        if: runner.os == 'Windows'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build Windows installer (.exe)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd installer

          # Create resources directory
          New-Item -ItemType Directory -Force -Path resources | Out-Null

          # Copy splash image
          Copy-Item "..\SeforimApp\src\jvmMain\assets\common\splash.png" "resources\splash.png"

          # Find and copy MSI
          $msiFile = Get-ChildItem "..\SeforimApp\build\compose\binaries\main-release\msi\Zayit-*.msi" | Select-Object -First 1
          if (-not $msiFile) {
            Write-Error "MSI not found"
            exit 1
          }
          Copy-Item $msiFile.FullName "resources\Zayit.msi"
          $msiBaseName = $msiFile.BaseName
          Write-Host "Found MSI: $msiBaseName"

          # Build Rust installer
          cargo build --release --target x86_64-pc-windows-msvc

          # Rename exe to match MSI name
          $exeName = "$msiBaseName.exe"
          Move-Item "target\x86_64-pc-windows-msvc\release\zayit-installer.exe" "target\x86_64-pc-windows-msvc\release\$exeName"
          Write-Host "Built installer: $exeName"

      - name: Build on macOS
        if: runner.os == 'macOS'
        shell: bash
        run: |
          chmod +x ./gradlew
          ./gradlew :SeforimApp:createReleaseDistributable ${{ matrix.build_task }} --no-daemon

      - name: Build summary
        run: echo "Build completed successfully for ${{ matrix.os }} (${{ matrix.arch }})"
        shell: bash
